{% extends "base.html" %}

{% block title %}Editar Propiedad{% endblock %}

{% block content %}
    {# Contenedor principal con card para unificar estilos y centrar el formulario #}
    <div class="container my-5 pt-5"> {# my-5 para margen vertical, pt-5 para compensar navbar fija #}
        <div class="row justify-content-center">
            <div class="col-lg-8 col-md-10"> {# Columnas para controlar el ancho en diferentes tamaños de pantalla #}
                <div class="card shadow-lg border-0 rounded-4 p-4"> {# Card con sombra, bordes y padding #}
                    {# Título principal del formulario #}
                    <h2 class="card-title text-center mb-4 fw-bold text-primary fs-3">Editar Propiedad: {{ property.titulo }}</h2>
                    
                    <form method="POST" action="" enctype="multipart/form-data" novalidate>
                        {{ form.hidden_tag() }} {# Campo oculto CSRF para seguridad #}
                        
                        {# Los campos del formulario (título, descripción, precio, etc.) #}
                        {# Se han actualizado las clases de Bootstrap 4 a Bootstrap 5 (form-group a mb-3, form-control-label a form-label, form-row a row g-3) #}
                        {# Y se ha asegurado la clase is-invalid para mostrar errores #}

                        <!-- Título -->
                        <div class="mb-3">
                            {{ form.titulo.label(class="form-label") }}
                            {{ form.titulo(class="form-control form-control-lg {% if form.titulo.errors %}is-invalid{% endif %}") }}
                            {% if form.titulo.errors %}
                                <div class="invalid-feedback">
                                    {% for error in form.titulo.errors %}
                                        <span>{{ error }}</span>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>

                        <!-- Descripción -->
                        <div class="mb-3">
                            {{ form.descripcion.label(class="form-label") }}
                            {{ form.descripcion(class="form-control form-control-lg {% if form.descripcion.errors %}is-invalid{% endif %}", rows=5) }}
                            {% if form.descripcion.errors %}
                                <div class="invalid-feedback">
                                    {% for error in form.descripcion.errors %}
                                        <span>{{ error }}</span>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>

                        <!-- Precio -->
                        <div class="mb-3">
                            {{ form.precio.label(class="form-label") }}
                            {{ form.precio(class="form-control form-control-lg {% if form.precio.errors %}is-invalid{% endif %}") }}
                            {% if form.precio.errors %}
                                <div class="invalid-feedback">
                                    {% for error in form.precio.errors %}
                                        <span>{{ error }}</span>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>

                        <!-- Ubicación -->
                        <div class="mb-3">
                            {{ form.ubicacion.label(class="form-label") }}
                            {{ form.ubicacion(class="form-control form-control-lg {% if form.ubicacion.errors %}is-invalid{% endif %}") }}
                            {% if form.ubicacion.errors %}
                                <div class="invalid-feedback">
                                    {% for error in form.ubicacion.errors %}
                                        <span>{{ error }}</span>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>

                        <!-- Municipio -->
                        <div class="mb-3">
                            {{ form.municipio.label(class="form-label") }}
                            {{ form.municipio(class="form-control form-control-lg {% if form.municipio.errors %}is-invalid{% endif %}") }}
                            {% if form.municipio.errors %}
                                <div class="invalid-feedback">
                                    {% for error in form.municipio.errors %}
                                        <span>{{ error }}</span>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>

                        <!-- Opciones de la Propiedad (Venta/Renta) -->
                        <div class="mb-3">
                            {{ form.property_options.label(class="form-label") }} 
                            {{ form.property_options(class="form-select form-select-lg {% if form.property_options.errors %}is-invalid{% endif %}") }} 
                            {% if form.property_options.errors %} 
                                <div class="invalid-feedback">
                                    {% for error in form.property_options.errors %} 
                                        <span>{{ error }}</span>
                                    {% endfor %}                                       
                                 </div>
                            {% endif %}
                        </div>

                        <!-- Tipo de Propiedad -->
                        <div class="mb-3">
                            {{ form.tipo_propiedad.label(class="form-label") }}
                            {{ form.tipo_propiedad(class="form-select form-select-lg {% if form.tipo_propiedad.errors %}is-invalid{% endif %}") }}
                            {% if form.tipo_propiedad.errors %}
                                <div class="invalid-feedback">
                                    {% for error in form.tipo_propiedad.errors %}
                                        <span>{{ error }}</span>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>

                        <!-- Campos numéricos opcionales -->
                        <div class="row g-3 mb-3">
                            <div class="col-md-4">
                                {{ form.num_habitaciones.label(class="form-label") }}
                                {{ form.num_habitaciones(class="form-control {% if form.num_habitaciones.errors %}is-invalid{% endif %}") }}
                                {% if form.num_habitaciones.errors %}
                                    <div class="invalid-feedback">
                                        {% for error in form.num_habitaciones.errors %}
                                            <span>{{ error }}</span>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                            <div class="col-md-4">
                                {{ form.num_banos.label(class="form-label") }}
                                {{ form.num_banos(class="form-control {% if form.num_banos.errors %}is-invalid{% endif %}") }}
                                {% if form.num_banos.errors %}
                                    <div class="invalid-feedback">
                                        {% for error in form.num_banos.errors %}
                                            <span>{{ error }}</span>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                            <div class="col-md-4">
                                {{ form.num_medios_banos.label(class="form-label") }}
                                {{ form.num_medios_banos(class="form-control {% if form.num_medios_banos.errors %}is-invalid{% endif %}") }}
                                {% if form.num_medios_banos.errors %}
                                    <div class="invalid-feedback">
                                        {% for error in form.num_medios_banos.errors %}
                                            <span>{{ error }}</span>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>

                        <div class="row g-3 mb-3">
                            <div class="col-md-4">
                                {{ form.num_estacionamientos.label(class="form-label") }}
                                {{ form.num_estacionamientos(class="form-control {% if form.num_estacionamientos.errors %}is-invalid{% endif %}") }}
                                {% if form.num_estacionamientos.errors %}
                                    <div class="invalid-feedback">
                                        {% for error in form.num_estacionamientos.errors %}
                                            <span>{{ error }}</span>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                            <div class="col-md-4">
                                {{ form.area_terreno_metros_cuadrados.label(class="form-label") }}
                                {{ form.area_terreno_metros_cuadrados(class="form-control {% if form.area_terreno_metros_cuadrados.errors %}is-invalid{% endif %}") }}
                                {% if form.area_terreno_metros_cuadrados.errors %}
                                    <div class="invalid-feedback">
                                        {% for error in form.area_terreno_metros_cuadrados.errors %}
                                            <span>{{ error }}</span>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                            <div class="col-md-4">
                                {{ form.area_construccion_metros_cuadrados.label(class="form-label") }}
                                {{ form.area_construccion_metros_cuadrados(class="form-control {% if form.area_construccion_metros_cuadrados.errors %}is-invalid{% endif %}") }}
                                {% if form.area_construccion_metros_cuadrados.errors %}
                                    <div class="invalid-feedback">
                                        {% for error in form.area_construccion_metros_cuadrados.errors %}
                                            <span>{{ error }}</span>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Cuota de Mantenimiento -->
                        <div class="mb-3">
                            {{ form.cuota_mantenimiento.label(class="form-label") }}
                            {{ form.cuota_mantenimiento(class="form-control form-control-lg {% if form.cuota_mantenimiento.errors %}is-invalid{% endif %}") }}
                            {% if form.cuota_mantenimiento.errors %}
                                <div class="invalid-feedback">
                                    {% for error in form.cuota_mantenimiento.errors %}
                                        <span>{{ error }}</span>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>

                        {# INICIO: Sección de Imágenes existentes y gestión #}
                        {% if property.images %}
                            <div class="mb-4"> {# Margen inferior para esta sección #}
                                <label class="form-label">Imágenes Actuales:</label>
                                <small class="text-muted d-block mb-2">Marca para eliminar, selecciona para principal.</small>
                                <div class="row row-cols-2 row-cols-md-3 row-cols-lg-4 g-2"> {# Grid responsivo para miniaturas #}
                                    {% for image in property.images %}
                                        <div class="col">
                                            <div class="card h-100 image-thumbnail-card position-relative {% if image.is_main %}border-success border-3{% endif %}"> {# Clase para JS y borde si es principal #}
                                                <img src="{{ url_for('static', filename='uploads/' + image.filename) }}"
                                                     class="img-thumbnail rounded" alt="Imagen de propiedad" style="width: 100%; height: 150px; object-fit: cover;">
                                                <div class="card-body p-2 text-center">
                                                    {# Checkbox para eliminar imagen #}
                                                    <div class="form-check form-check-inline">
                                                        <input class="form-check-input delete-image-checkbox" type="checkbox" name="delete_images" value="{{ image.id }}" id="delete_image_{{ image.id }}">
                                                        <label class="form-check-label" for="delete_image_{{ image.id }}">Eliminar</label>
                                                    </div>
                                                    
                                                    {# Radio button para seleccionar imagen principal #}
                                                    <div class="form-check form-check-inline">
                                                        <input class="form-check-input main-image-radio" type="radio" name="principal_image" value="{{ image.id }}" id="main_image_{{ image.id }}" {% if image.is_main %}checked{% endif %}>
                                                        <label class="form-check-label" for="main_image_{{ image.id }}">Principal</label>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    {% endfor %}
                                </div>
                            </div>
                        {% endif %}
                        {# FIN: Sección de Imágenes existentes y gestión #}

                        <!-- Campo de Imágenes (para añadir nuevas imágenes durante la edición) -->
                        <div class="mb-3">
                            {{ form.imagenes.label(class="form-label") }}
                            {{ form.imagenes(class="form-control {% if form.imagenes.errors %}is-invalid{% endif %}", multiple=True) }}
                            {% if form.imagenes.errors %}
                                <div class="invalid-feedback">
                                    {% for error in form.imagenes.errors %}
                                        <span>{{ error }}</span>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>

                        <div class="d-grid mt-4"> {# d-grid y mt-4 para el botón #}
                            {{ form.submit(class="btn btn-primary btn-lg rounded-3 fw-bold") }} {# Botón de envío #}
                        </div>
                    </form>
                    {# Botón de Cancelar #}
                    <div class="text-center mt-3">
                        <a href="{{ url_for('main.property_detail', property_id=property.id) }}" class="btn btn-secondary btn-sm">Cancelar</a>
                    </div>
                </div> {# Fin card #}
            </div> {# Fin col #}
        </div> {# Fin row #}
    </div> {# Fin container #}

    {# INICIO: Script JS para feedback visual de gestión de imágenes #}
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const imageCards = document.querySelectorAll('.image-thumbnail-card');

            imageCards.forEach(card => {
                const checkbox = card.querySelector('.delete-image-checkbox');
                const radio = card.querySelector('.main-image-radio');

                // Función para actualizar estilos de la tarjeta
                function updateCardStyles() {
                    card.classList.remove('border-danger', 'border-success', 'border-3'); // Limpiar bordes

                    if (checkbox && checkbox.checked) {
                        card.classList.add('border-danger', 'border-3'); // Rojo si está marcada para eliminar
                        card.style.opacity = '0.7';
                    } else if (radio && radio.checked) {
                        card.classList.add('border-success', 'border-3'); // Verde si es la imagen principal
                        card.style.opacity = '1';
                    } else {
                        card.style.opacity = '1'; // Opacidad normal si no está marcada
                    }
                }

                // Event Listeners
                if (checkbox) {
                    checkbox.addEventListener('change', updateCardStyles);
                }
                if (radio) {
                    radio.addEventListener('change', function() {
                        // Desmarcar principal de otras tarjetas visualmente
                        document.querySelectorAll('.main-image-radio').forEach(otherRadio => {
                            if (otherRadio !== radio && otherRadio.checked) {
                                otherRadio.checked = false; // Desmarcar el radio button
                                otherRadio.closest('.image-thumbnail-card').classList.remove('border-success', 'border-3');
                            }
                        });
                        updateCardStyles(); // Actualizar el estilo de la tarjeta actual
                    });
                }

                // Aplicar estilos iniciales al cargar la página
                updateCardStyles();
            });
        });
    </script>
    {# FIN: Script JS para feedback visual #}

{% endblock content %}
